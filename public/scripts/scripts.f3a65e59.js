"use strict";angular.module("intellogoWidgets",["ngRoute","ngMaterial","rest","dibari.angular-ellipsis"]).config(["$routeProvider","$mdThemingProvider",function(a,b){b.theme("default").primaryPalette("teal").accentPalette("orange").warnPalette("red"),a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",resolve:{inputParams:["Params",function(a){return a.getDeferValue()}]}}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","REST_EVENTS","UserDataService","Params",function(a,b,c,d,e){a.$on(c.LOGOUT,function(){d.resetUserData()}),a.$on(c.AUTHENTICATION_SUCCESS,function(){try{var a=JSON.parse(b.hash());return void e.setValue(a)}catch(c){console.log(c),console.log("URL Hash parameter is not a valid configuration")}window.addEventListener("message",function(a){if(document.referrer.startsWith(a.origin)){var b=JSON.parse(a.data);e.setValue(b)}},!1),window.top.length&&window.top.postMessage("ready",document.referrer)}),a.$on(c.AUTHENTICATION_FAILURE,function(){console.error("Unable to authenticate.")}),a.$emit(c.AUTHENTICATE_CLIENT_SECRET)}]),angular.module("intellogoWidgets").constant("iwConstants",{defaultRerateDaysThreshold:7,defaultSourceGroups:[{sourceName:"Web",sourceValue:"web"},{sourceName:"Wiki",sourceValue:"wikipedia"},{sourceName:"Books",sourceValue:"books"}],recommendationsPollInterval:5e3}).constant("OAUTH_CLIENT_ID","recommendationsWidget").constant("OAUTH_CLIENT_SECRET","2b53761249254ce6b502f521e5cc0683"),angular.module("intellogoWidgets").controller("MainCtrl",["$scope","inputParams","DataRetriever","iwConstants","SourcesManager",function(a,b,c,d,e){function f(){"content"===b.recommendationOptions?(a.contents.showCategories&&g(),i(!0)):"insight"===b.recommendationOptions&&g()}function g(){c.getInsights(a.selected.item.data.metadata.sourceId).then(function(b){a.contents.categories=b})}function h(){var b={contentId:a.selected.item.data.contentId,from:0,to:30};return a.selected.date&&(b.recommendationsAcquisitionDate=Date.parse(a.selected.date)),"all"===a.selected.source?(b.recommendationsSourceGroup=m.sourceGroups,b.recommendationsSource=m.sources):m.sourceGroups.indexOf(a.selected.source)>-1?b.recommendationsSourceGroup=a.selected.source:b.recommendationsSource=a.selected.source,b}function i(f){a.contents.loadingRecommendations=!0;var g=h();return f&&(g.includeLastRated=!0),c.getRecommendations(g,!f).then(function(f){if(f.lastRated){var g=_.isNumber(b.rerateDaysThreshold)?b.rerateDaysThreshold:d.defaultRerateDaysThreshold,h=e.needRerating(f.lastRated,g);if(h.length)return c.startTask(a.selected.item,h).then(function(b){return a.selected.item.taskInfo=b.taskInfo,i()})}a.contents.recommendations=f?f.ratings:[],a.contents.loadingRecommendations=!1},angular.noop,function(b){a.contents.recommendations=b.ratings})}function j(){a.contents.loadingRecommendations=!0;var b={};return"all"===a.selected.source?(b.source=m.sources,b.sourceGroups=m.sourceGroups):m.sourceGroups.indexOf(a.selected.source)>-1?b.sourceGroups=a.selected.source:b.source=a.selected.source,a.selected.date&&(b.date=Date.parse(a.selected.date)),c.getCategoryRecommendations(a.selected.categoryId,b).then(function(b){a.contents.loadingRecommendations=!1,a.contents.recommendations=b})}function k(){return function(){return"content"===b.recommendationOptions?i():"insight"===b.recommendationOptions?j():angular.noop}}function l(){var a={sourceName:"All",sourceValue:"all"},c=b.sources||[],d=b.sourceGroups||[];return[a].concat(c.concat(d))}var m={sources:_.pluck(b.sources,"sourceValue"),sourceGroups:_.pluck(b.sourceGroups,"sourceValue")},n=k();a.selected={item:null,categoryId:null,date:null,source:"all",type:b.contentSelection.type},a.contents={errors:[],categories:[],loadingRecommendations:!1,recommendations:[],showCategories:b.showInsights||"insight"===b.recommendationOptions,sources:l()},a.getCategoryRecommendations=function(c){"insight"===b.recommendationOptions&&(a.selected.categoryId=c,j())},a.$watch("selected.source",function(b){b&&a.selected.item&&n()}),a.$watch("selected.date",function(a,b){(a||b)&&n()}),a.$watch("selected.item",function(b){b&&(a.contents.categories=[],a.contents.recommendations=[],f())})}]),angular.module("intellogoWidgets").directive("iwCategoriesList",[function(){return{templateUrl:"views/categoriesList.html",restrict:"A",controller:["$scope","Params",function(a,b){a.recommendationOption=b.getValue().recommendationOptions}]}}]),angular.module("intellogoWidgets").directive("iwDropdown",[function(){return{templateUrl:"views/dropdown.html",restrict:"A",require:"^MainCtrl",controller:["$scope","$q","DataRetriever","Params",function(a,b,c,d){a.contents.givenPublications=[];var e=b.defer(),f=d.getValue(),g=e.promise;e.resolve(),_.each(f.contentSelection.urls,function(d){g=g.then(function(){return c.getDataBySourceId(d).then(function(b){a.contents.givenPublications.push(b)},function(c){return a.contents.errors.push(c),b.resolve()})})}),g.then(function(){a.selected.item=a.contents.givenPublications[0]})}]}}]),angular.module("intellogoWidgets").directive("iwErrorCard",function(){return{templateUrl:"views/errorCard.html",restrict:"A",scope:{type:"@",msg:"=",clear:"="},controller:["$scope",function(a){console.log(a.msg)}]}}),angular.module("intellogoWidgets").directive("iwKeywordSearch",function(){return{templateUrl:"views/keywordSearch.html",restrict:"A",require:"^MainCtrl",controller:["$scope","ContentService",function(a,b){a.search={txt:""},a.getMatches=function(a){return a?b.getAllContentsInCategories(0,30,{search:a}).then(function(a){return a.data}):[]},a.$watch("selectedItem",function(b){b?a.selected.item={data:b}:a.selected.item=null})}]}}),angular.module("intellogoWidgets").directive("iwPaste",function(){return{templateUrl:"views/paste.html",restrict:"A",require:"^MainCtrl",controller:["$scope","DataRetriever","TrainingService",function(a,b,c){a.findMatches=function(c){13===c.keyCode&&(a.showSourceRetrievalSpinner=!0,b.getDataBySourceId(a.pasteUrl).then(function(b){a.showSourceRetrievalSpinner=!1,a.contents.errors=[],a.selected.item=b},function(b){a.showSourceRetrievalSpinner=!1,a.contents.errors=[],a.contents.errors.push(b),a.contents.categories=[],a.contents.recommendations=[]}))},a.returnToInput=function(){a.contents.loadingRecommendations&&(a.selected.item.taskInfo&&c.cancelTask(a.selected.item.taskInfo.taskId),a.contents.loadingRecommendations=!1),a.selected.item=null,a.pasteUrl=null,a.contents.errors=[],a.contents.categories=[],a.contents.recommendations=[]}}]}}),angular.module("intellogoWidgets").directive("iwPublication",function(){return{templateUrl:"views/publication.html",restrict:"A",scope:{showAsMatch:"=",pub:"=publication",updating:"=disabled"},controller:["$scope",function(a){a.getImageUrl=function(a){return a&&a.url?a.url.constructor===Array?a.url[0]:a.url:""},a.getBookSummary=function(a){if(a.masterId&&"Epubs"===a.source){var b=a.title.substring(0,a.title.indexOf("."));return"This is a chapter of the book <b>"+b+"</b>"}return a.summary}}]}}),angular.module("intellogoWidgets").directive("iwRecommendationsList",function(){return{templateUrl:"views/recommendationsList.html",restrict:"A",controller:["$scope",function(a){function b(a,b){return a.getDate()===b.getDate()&&a.getMonth()===b.getMonth()&&a.getFullYear()===b.getFullYear()}a.isSelectedDate=function(c){var d=new Date;return d.setDate(d.getDate()-c),!!a.selected.date&&b(a.selected.date,d)},a.pickDate=function(b){var c=new Date;c.setDate(c.getDate()-b),a.selected.date=c},a.openLink=function(b){a.contents.loadingRecommendations&&b.preventDefault()}}]}}),angular.module("intellogoWidgets").filter("sourceLinkFilter",function(){return function(a){function b(a){return!!_.isString(a)&&a.match(/^https?:\/\//)}function c(a,c){var d=b(c);return"Wikipedia"===a?"https://en.wikipedia.org/?curid="+c:"Project Gutenberg"===a?"https://www.gutenberg.org/ebooks/"+c:"Scribd"===a||"ScribdBooks"===a?"https://www.scribd.com/read/"+c:d?c:""}var d=a.metadata;return d&&d.source?c(d.source,d.sourceId):""}}),angular.module("intellogoWidgets").factory("DataRetriever",["$q","$timeout","ContentService","CategoryService","RatingService","Params","iwConstants","SourcesManager",function(a,b,c,d,e,f,g,h){function i(b){return c.importArticles([{url:b,source:"imported"}]).then(function(b){return b.data[0].success||b.data[0].existingIds?b.data[0]:a.reject(b.data[0].error)})}function j(a,b){return b||(b=h.getItemsToRate()),e.getContentRatingsForContentInitiateTraining({contentId:a.data.contentId,itemsToRate:b}).then(function(b){return{data:a.data,taskInfo:{taskId:b.data.task.taskId,requestId:b.data.requestId}}})}function k(a){return c.getContentsBySourceId(a).then(function(b){return b.data.length?{data:b.data[0]}:i(a).then(function(b){return b.success?k(a).then(j):l(b.existingIds)})})}function l(a){return c.getContentsByIds(a).then(function(a){return{data:a.data[0]}})}function m(b){return k(b).then(function(b){return e.getCategoryRatingsForContent(b.data.contentId,!0,null,null,.7).then(function(b){var c=[];return _.each(b.data,function(a){c.push(n(a.trainingSetId.categoryId._id))}),a.all(c).then(function(a){return _.each(b.data,function(b,c){b.trainingSetId.categoryId.images=a[c]}),b.data})})})}function n(a){return d.getCategoryImages(a,4).then(function(a){return a.data})}function o(c,d){function f(a){return a.status&&"finished"!==a.status&&"cancelled"!==a.status&&"failed"!==a.status}function h(a,c){return c.cancel?void i.reject():(e.getContentRatingsForContent(a).then(function(d){f(d.data.task)?(i.notify(d.data),b(function(){return h(a,c)},g.recommendationsPollInterval)):i.resolve(d.data)}),i.promise)}var i=a.defer(),j={cancel:!1};return q.cancel=!0,q=j,d?h(c,q):e.getContentRatingsForContent(c).then(function(a){return a.data})}function p(a,b){return e.getRatings(a,b).then(function(a){return a.data})}var q={cancel:!1};return{startTask:j,getCategoryRecommendations:p,getDataBySourceId:k,getInsights:m,getCategoryImages:n,getRecommendations:o}}]),angular.module("intellogoWidgets").factory("Params",["$q","iwConstants",function(a,b){var c,d=a.defer();return{setValue:function(a){c=a,a.sources&&a.sources.length||a.sourceGroups&&a.sourceGroups.length||(c.sourceGroups=b.defaultSourceGroups),d.resolve()},getValue:function(){return c},getDeferValue:function(){return d.promise.then(function(){return a.when(c)})}}}]),angular.module("intellogoWidgets").factory("SourcesManager",["Params",function(a){function b(a,b){var c=[];return _.each(a,function(a){if(a.sourceValue){var d={};d[b]=a.sourceValue,c.push(d)}}),c}function c(){var c=a.getValue(),d=angular.isArray(c.sources)?c.sources:[],e=angular.isArray(c.sourceGroups)?c.sourceGroups:[],f=b(d,"source");return f=f.concat(b(e,"sourceGroup"))}function d(a,b){for(var c=[],d=0;d<a.length;d++){for(var e=!1,f=0;f<b.length;f++)if(_.isEqual(a[d],b[f])){e=!0;break}e||c.push(a[d])}return c}function e(a,b){var c,d=new Date;return d.setDate(d.getDate()-b),c=d.getTime(),_.filter(a,function(a){return a.timeStarted-c>0})}function f(a,b){var f=c();if(!a||!a.length)return f;for(var g=e(a,b),h=[],i=0;i<g.length;i++){if(g[i].itemsToRate&&0===g[i].itemsToRate.length)return[];for(var j=0;f&&j<f.length;j++)_.find(g[i].itemsToRate,f[j])&&!_.find(h,f[j])&&h.push(f[j])}return d(f,h)}return{getItemsToRate:c,needRerating:f}}]);